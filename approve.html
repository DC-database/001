
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Approval</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .approval-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .approval-container h1 {
      text-align: center;
      color: var(--primary);
    }
    .approval-info {
      margin: 20px 0;
      font-size: 16px;
    }
    .signature-box {
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 150px;
      margin-top: 10px;
    }
    canvas {
      width: 100%;
      height: 150px;
      border-radius: 4px;
    }
    .btn-group {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .btn {
      flex: 1;
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div class="approval-container">
    <h1>Invoice Approval</h1>
    <div class="approval-info">
      <p><strong>PO Number:</strong> <span id="poNumber"></span></p>
      <p><strong>Invoice Number:</strong> <span id="invoiceNumber"></span></p>
      <p><strong>Invoice PDF:</strong> <a id="pdfLink" href="#" target="_blank">View</a></p>
    </div>
    <label for="signature">Draw your signature:</label>
    <div class="signature-box">
      <canvas id="signatureCanvas"></canvas>
    </div>
    <div class="btn-group">
      <button class="btn btn-warning" onclick="clearSignature()">Clear</button>
      <button class="btn btn-success" onclick="submitApproval()">Approve</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDtEp9HL7MfOlnrCI-MWuTY4k6vuGTMCIs",
      authDomain: "invoice-ac1bc.firebaseapp.com",
      databaseURL: "https://invoice-ac1bc-default-rtdb.firebaseio.com",
      projectId: "invoice-ac1bc",
      storageBucket: "invoice-ac1bc.appspot.com",
      messagingSenderId: "345752448964",
      appId: "1:345752448964:web:e57f43e36ad3aa11efbe91"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const po = urlParams.get("po");
    const invoice = urlParams.get("invoice");

    document.getElementById("poNumber").textContent = po;
    document.getElementById("invoiceNumber").textContent = invoice;
    document.getElementById("pdfLink").href = `https://ibaqatar-my.sharepoint.com/personal/dc_iba_com_qa/Documents/DC%20Files/INVOICE/${invoice}.pdf`;

    const canvas = document.getElementById("signatureCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;

    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mouseout", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    function draw(e) {
      if (!drawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "black";
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
    }

    function submitApproval() {
      const year = new Date().getFullYear().toString();
      const recordsRef = db.ref(`records/${year}`);

      recordsRef.once("value").then(snapshot => {
        const records = snapshot.val();
        if (!records) return alert("No records found.");

        const updatedRecords = Object.values(records).map(r => {
          if (r.poNumber === po && (!invoice || r.invoiceNumber === invoice)) {
            r.status = "Approved";
            r.lastUpdated = new Date().toISOString();
            r.approvedBy = "Signed via Link";
          }
          return r;
        });

        const updatedObj = {};
        updatedRecords.forEach((r, i) => {
          updatedObj[i] = r;
        });

        return recordsRef.set(updatedObj);
      }).then(() => {
        alert("Invoice approved successfully!");
        window.location.href = "https://dc-database.github.io/001/";
      }).catch(err => {
        alert("Error approving: " + err.message);
      });
    }
  </script>
</body>
</html>
